name: Scrape Costco Deals

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Costco Intel
        uses: actions/checkout@v4

      - name: Checkout DeadManUltimateScraper
        uses: actions/checkout@v4
        with:
          repository: DeadManOfficial/DeadManUltimateScraper
          path: scraper

      - name: Checkout token-optimization
        uses: actions/checkout@v4
        with:
          repository: DeadManOfficial/token-optimization
          path: token-optimization

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install TOR
        run: |
          sudo apt-get update
          sudo apt-get install -y tor
          sudo service tor start
          sleep 10
          curl --socks5-hostname 127.0.0.1:9050 https://check.torproject.org/api/ip || echo "TOR check failed"

      - name: Install dependencies
        run: |
          # Install token-optimization
          cd token-optimization && pip install -r requirements.txt || true && cd ..

          # Install DeadMan scraper deps
          cd scraper && pip install -e . --no-deps || true && cd ..
          pip install curl_cffi httpx beautifulsoup4 pydantic pyyaml stem tldextract fake-useragent requests aiohttp lxml

      - name: Run DeadMan Costco Scraper
        working-directory: ./scraper
        env:
          PYTHONPATH: "${{ github.workspace }}/token-optimization:${{ github.workspace }}/scraper"
        run: |
          python -c "
          import asyncio
          import sys
          sys.path.insert(0, '.')
          from deadman_scraper.scrapers.costco_scraper import scrape_all_keywords, save_deals

          async def main():
              deals = await scrape_all_keywords(['clearance', 'deals', 'sale'], limit=100)
              if deals:
                  save_deals(deals)
              else:
                  print('No deals found')

          asyncio.run(main())
          "

      - name: Copy deals to web
        run: |
          if [ -f scraper/web/src/data/deals.json ]; then
            cp scraper/web/src/data/deals.json web/src/data/deals.json
          elif [ -f web/src/data/deals.json ]; then
            echo "Using existing deals.json"
          fi

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet web/src/data/deals.json 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add web/src/data/deals.json
          git commit -m "chore: Update deals [DeadMan Scraper]"
          git push

      - name: Summary
        run: |
          echo "### DeadMan Scraper Complete" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.check.outputs.changed }}" == "true" ]; then
            echo "✅ New deals committed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "ℹ️ No changes" >> "$GITHUB_STEP_SUMMARY"
          fi
